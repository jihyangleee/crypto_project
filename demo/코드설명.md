# μ½”λ“ κµ¬μ΅° λ° μ£Όμ” κΈ°λ¥ μ„¤λ…

## π“‚ ν”„λ΅μ νΈ κµ¬μ΅°

```
demo/src/main/java/com/example/app/
β”β”€β”€ net/                    # λ„¤νΈμ›ν¬ ν†µμ‹  κ³„μΈµ
β”‚   β”β”€β”€ ChatClient.java     # ν΄λΌμ΄μ–ΈνΈ μ—°κ²° λ° μ „μ†΅
β”‚   β””β”€β”€ ChatServer.java     # μ„λ²„ μμ‹  λ° μ²λ¦¬
β”β”€β”€ model/                  # μ•”νΈν™” μ ν‹Έλ¦¬ν‹°
β”‚   β””β”€β”€ CryptoUtil.java     # RSA, AES μ•”νΈν™”/λ³µνΈν™”
β”β”€β”€ crypto/                 # μ•”νΈν™” μ„λΉ„μ¤ μΈν„°νμ΄μ¤
β”‚   β”β”€β”€ KeyService.java
β”‚   β”β”€β”€ EncryptService.java
β”‚   β””β”€β”€ SignService.java
β”β”€β”€ services/mock/          # μ‹¤μ  κµ¬ν„μ²΄
β”‚   β”β”€β”€ RealKeyService.java
β”‚   β”β”€β”€ RealEncryptService.java
β”‚   β””β”€β”€ RealSignService.java
β”β”€β”€ ui/                     # JavaFX UI μ»¨νΈλ΅¤λ¬
β”‚   β””β”€β”€ MainViewController.java
β””β”€β”€ domain/                 # λ°μ΄ν„° λ¨λΈ
    β”β”€β”€ KeyInfo.java
    β”β”€β”€ Packet.java
    β””β”€β”€ LogEntry.java
```

---

## π” ν•µμ‹¬ μ•”νΈν™” νλ¦„

### 1οΈβƒ£ **μ—°κ²° λ° ν‚¤ κµν™ (ChatClient.connect / ChatServer.start)**

```
ν΄λΌμ΄μ–ΈνΈ                          μ„λ²„
    |                                |
    |  1) μ„λ²„ RSA κ³µκ°ν‚¤ μμ‹        |
    |<-------------------------------|
    |                                |
    |  2) ν΄λΌμ΄μ–ΈνΈ RSA κ³µκ°ν‚¤ μ „μ†΅ |
    |------------------------------>|
    |                                |
    |  3) AES μ„Έμ…ν‚¤ μƒμ„±             |
    |     μ„λ²„ κ³µκ°ν‚¤λ΅ μ•”νΈν™”        |
    |     μ•”νΈν™”λ AES ν‚¤ μ „μ†΅       |
    |------------------------------>|
    |                                |  4) μ„λ²„ κ°μΈν‚¤λ΅ λ³µνΈν™”
    |                                |     AES μ„Έμ…ν‚¤ νλ“
```

**μ£Όμ” μ½”λ“ (ChatClient.java):**
```java
// μ„λ²„μ RSA κ³µκ°ν‚¤λ΅ AES μ„Έμ…ν‚¤λ¥Ό μ•”νΈν™”ν•΄μ„ μ „μ†΅
javax.crypto.SecretKey aes = KeyGenerator.getInstance("AES").generateKey();
byte[] aesRaw = aes.getEncoded();
byte[] encAes = CryptoUtil.rsaEncrypt(peerPublicKey, aesRaw); // RSAλ΅ λν•‘
```

**μ£Όμ” μ½”λ“ (ChatServer.java):**
```java
// μ„λ²„μ κ°μΈν‚¤λ΅ μ•”νΈν™”λ AES μ„Έμ…ν‚¤λ¥Ό λ³µνΈν™”
byte[] aesRaw = CryptoUtil.rsaDecrypt(kp.getPrivate(), encAes);
SecretKey aesKey = CryptoUtil.aesKeyFromBytes(aesRaw);
```

---

### 2οΈβƒ£ **λ©”μ‹μ§€ μ „μ†΅ (μ•”νΈν™” + μ„λ…)**

```
ν΄λΌμ΄μ–ΈνΈ μΈ΅ (ChatClient.send):
1. ν‰λ¬Έ μ¤€λΉ„: "Hello"
2. μ„λ… μƒμ„±: SHA256withRSA(ν‰λ¬Έ) β†’ 256λ°”μ΄νΈ μ„λ…
3. ν‰λ¬Έ μ•”νΈν™”: AES-GCM(ν‰λ¬Έ) β†’ μ•”νΈλ¬Έ
4. μ„λ… μ•”νΈν™”: AES-GCM(μ„λ…) β†’ μ•”νΈν™”λ μ„λ…
5. μ „μ†΅:
   - TYPE_CHAT(1): μ•”νΈν™”λ ν‰λ¬Έ
   - TYPE_SIGNATURE(5): μ•”νΈν™”λ μ„λ…
```

**μ£Όμ” μ½”λ“ (ChatClient.java):**
```java
if (encrypt && sign) {
    // ν‰λ¬Έμ— μ„λ… μƒμ„± (SHA256withRSA)
    byte[] signature = signData(pt);
    
    // ν‰λ¬Έ μ•”νΈν™”ν•΄μ„ μ „μ†΅
    sendFramed(1, pt);  // TYPE_CHAT
    
    // μ„λ… μ•”νΈν™”ν•΄μ„ μ „μ†΅
    sendFramed(5, signature);  // TYPE_SIGNATURE
}
```

---

### 3οΈβƒ£ **λ©”μ‹μ§€ μμ‹  λ° κ²€μ¦ (ChatServer)**

```
μ„λ²„ μΈ΅:
1. AES ν‚¤λ΅ μ•”νΈλ¬Έ λ³µνΈν™” β†’ ν‰λ¬Έ νλ“
2. AES ν‚¤λ΅ μ„λ… λ³µνΈν™” β†’ μ„λ… νλ“
3. ν΄λΌμ΄μ–ΈνΈ κ³µκ°ν‚¤λ΅ μ„λ… κ²€μ¦:
   - ν‰λ¬Έμ SHA-256 ν•΄μ‹ κ³„μ‚°
   - μ„λ…μ„ κ³µκ°ν‚¤λ΅ λ³µνΈν™”
   - λ‘ ν•΄μ‹κ°’ λΉ„κµ β†’ verified true/false
```

**μ£Όμ” μ½”λ“ (ChatServer.java):**
```java
// 1. μ•”νΈλ¬Έ λ³µνΈν™”
byte[] plain = CryptoUtil.aesDecrypt(aesKey, ct, msgIv);

// 2. μ„λ… λ³µνΈν™”
byte[] signature = CryptoUtil.aesDecrypt(aesKey, ct, msgIv);

// 3. μ„λ… κ²€μ¦
java.security.Signature sig = Signature.getInstance("SHA256withRSA");
sig.initVerify(clientPub);  // ν΄λΌμ΄μ–ΈνΈ κ³µκ°ν‚¤ μ‚¬μ©
sig.update(lastPlaintext);  // ν‰λ¬Έ ν•΄μ‹ κ³„μ‚°
boolean verified = sig.verify(signature);  // μ„λ… κ²€μ¦
```

---

## π”§ μ£Όμ” μ•”νΈν™” μ•κ³ λ¦¬μ¦

### **CryptoUtil.java**

| λ©”μ„λ“ | μ•κ³ λ¦¬μ¦ | μ©λ„ |
|--------|---------|------|
| `rsaEncrypt()` | RSA-2048 OAEP (SHA-256) | AES μ„Έμ…ν‚¤ μ•”νΈν™” |
| `rsaDecrypt()` | RSA-2048 OAEP (SHA-256) | AES μ„Έμ…ν‚¤ λ³µνΈν™” |
| `aesEncrypt()` | AES-128-GCM | λ©”μ‹μ§€/νμΌ μ•”νΈν™” |
| `aesDecrypt()` | AES-128-GCM | λ©”μ‹μ§€/νμΌ λ³µνΈν™” |

### **μ„λ… μ•κ³ λ¦¬μ¦ (ChatClient.signData)**
```java
Signature signer = Signature.getInstance("SHA256withRSA");
signer.initSign(myPrivateKey);  // λ‚΄ κ°μΈν‚¤λ΅ μ„λ…
signer.update(data);            // ν‰λ¬Έ ν•΄μ‹ κ³„μ‚°
return signer.sign();           // μ„λ… μƒμ„±
```

---

## π“ μ „μ†΅ λ¨λ“ (4κ°€μ§€)

| μ•”νΈν™” | μ„λ… | μ„¤λ… | λ©”μ‹μ§€ νƒ€μ… |
|--------|------|------|------------|
| β… | β… | μ•”νΈν™” + μ„λ… (κΈ°λ³Έκ°’) | TYPE_CHAT(1) + TYPE_SIGNATURE(5) |
| β… | β | μ•”νΈν™”λ§ | TYPE_CHAT(1) |
| β | β… | ν‰λ¬Έ + μ„λ… | TYPE_PLAINTEXT_CHAT(7) + TYPE_PLAINTEXT_SIGNATURE(8) |
| β | β | ν‰λ¬Έλ§ | TYPE_PLAINTEXT_CHAT(7) |

---

## π― μ²΄ν¬λ°•μ¤ λ™μ‘ μ›λ¦¬

**MainViewController.java:**
```java
// UI μ²΄ν¬λ°•μ¤ μ½κΈ°
boolean shouldEncrypt = encryptCheck.isSelected();
boolean shouldSign = signCheck.isSelected();

// μ „μ†΅ μ‹ μ μ©
client.send(text, shouldEncrypt, shouldSign);
client.sendFile(file, shouldEncrypt, shouldSign);
```

---

## π” μ„λ²„μ μ„λ… κ²€μ¦ λ€κΈ° λ΅μ§

λ¬Έμ : μ„λ… μ—†λ” λ©”μ‹μ§€κ°€ λ‘ λ² ν΄λ¦­ν•΄μ•Ό μ „μ†΅λλ μ΄μ  
ν•΄κ²°: 50ms λ€κΈ° ν›„ λ‹¤μ λ°μ΄ν„° ν™•μΈ

```java
// λ©”μ‹μ§€ μμ‹  ν›„ μ„λ…μ΄ μ¬μ§€ 50ms λ€κΈ°
Thread.sleep(50);

if (in.available() == 0) {
    // μ„λ… μ—†μ - μ¦‰μ‹ UIμ— ν‘μ‹
    onMessageReceived.accept(data);
} else {
    // μ„λ… λ€κΈ° μ¤‘ - λ‹¤μ λ£¨ν”„μ—μ„ μ²λ¦¬
}
```

---

## π“ νμΌ μ „μ†΅ νλ¦„

1. **λ©”νƒ€λ°μ΄ν„° μ „μ†΅**: νμΌλ… + νμΌ ν¬κΈ°
2. **μ²­ν¬ λ‹¨μ„ μ „μ†΅**: 8192λ°”μ΄νΈμ”© λ¶„ν•  μ „μ†΅
3. **μ„λ… μ „μ†΅** (μ„ νƒ): μ „μ²΄ νμΌ λ°μ΄ν„°μ— λ€ν• μ„λ…
4. **μΆ…λ£ μ‹ νΈ**: TYPE_FILE_END

```java
// μ•”νΈν™” νμΌ μ „μ†΅
sendFramed(2, meta);           // TYPE_FILE_META
sendFramed(3, chunk);          // TYPE_FILE_CHUNK (λ°λ³µ)
sendFramed(6, signature);      // TYPE_FILE_SIGNATURE (μ„ νƒ)
sendFramed(4, new byte[0]);    // TYPE_FILE_END
```

---

## π›΅οΈ λ³΄μ• νΉμ§•

1. **ν•μ΄λΈλ¦¬λ“ μ•”νΈν™”**: RSAλ΅ AES ν‚¤λ¥Ό μ•μ „ν•κ² μ „μ†΅, AESλ΅ μ‹¤μ  λ°μ΄ν„° μ•”νΈν™”
2. **μΈμ¦λ μ•”νΈν™”**: AES-GCM λ¨λ“λ΅ λ¬΄κ²°μ„± μλ™ κ²€μ¦
3. **λ””μ§€ν„Έ μ„λ…**: SHA256withRSAλ΅ λ°μ‹ μ μΈμ¦ λ° λ³€μ΅° λ°©μ§€
4. **λ§¤ μ„Έμ… μƒ ν‚¤**: μ—°κ²°λ§λ‹¤ μƒλ΅μ΄ AES μ„Έμ…ν‚¤ μƒμ„±
5. **μ„ νƒμ  λ³΄μ•**: μ‚¬μ©μκ°€ μ•”νΈν™”/μ„λ… μ—¬λ¶€λ¥Ό μ„ νƒ κ°€λ¥

---

## π€ μ‹¤ν–‰ λ°©λ²•

```powershell
cd d:\crypto_pro\demo
.\gradlew.bat runSecureUI
```

- λ‘ κ°μ μ°½μ„ λ„μ› ν•λ‚λ” Server, ν•λ‚λ” Clientλ΅ μ„¤μ •
- Serverμ—μ„ λ¨Όμ € Connect β†’ Clientμ—μ„ Connect
- μ—°κ²° ν›„ μ²΄ν¬λ°•μ¤λ΅ μ•”νΈν™”/μ„λ… μµμ… μ„ νƒν•μ—¬ λ©”μ‹μ§€/νμΌ μ „μ†΅

---

## π“ λ΅κ·Έ ν™•μΈ

UI ν•λ‹¨μ Logs νƒ­μ—μ„ λ¨λ“  μ•”νΈν™” κ³Όμ •μ„ μ‹¤μ‹κ°„μΌλ΅ ν™•μΈ κ°€λ¥:
- ν‚¤ κµν™ κ³Όμ •
- μ•”νΈν™”/λ³µνΈν™” λ‹¨κ³„
- μ„λ… μƒμ„± λ° κ²€μ¦ κ²°κ³Ό
- νμΌ μ „μ†΅ μ§„ν–‰ μƒν™©
